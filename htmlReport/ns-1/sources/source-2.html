


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > Database</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">oopassignment.config</a>
</div>

<h1>Coverage Summary for Class: Database (oopassignment.config)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">Database</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (12/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    40%
  </span>
  <span class="absValue">
    (8/20)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    63.8%
  </span>
  <span class="absValue">
    (44/69)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package oopassignment.config;
&nbsp;
&nbsp;import java.sql.Connection;
&nbsp;import java.sql.DriverManager;
&nbsp;import java.sql.PreparedStatement;
&nbsp;import java.sql.ResultSet;
&nbsp;import java.sql.SQLException;
&nbsp;import java.sql.Statement;
&nbsp;import oopassignment.util.PasswordHasher;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.slf4j.LoggerFactory;
&nbsp;
&nbsp;/**
&nbsp; * Minimal JDBC bootstrapper. Tries to open the configured DB_URL and creates tables if they don&#39;t exist.
&nbsp; * Falls back silently when no JDBC driver is present so the in-memory repositories can still run.
&nbsp; */
&nbsp;public final class Database {
&nbsp;
<b class="fc">&nbsp;    private static final Logger LOG = LoggerFactory.getLogger(Database.class);</b>
<b class="fc">&nbsp;    private static final PasswordHasher HASHER = new PasswordHasher();</b>
&nbsp;    private static boolean available;
&nbsp;
&nbsp;    static {
<b class="fc">&nbsp;        boolean driverLoaded = true;</b>
&nbsp;        try {
<b class="fc">&nbsp;            Class.forName(&quot;org.sqlite.JDBC&quot;);</b>
&nbsp;        } catch (ClassNotFoundException e) {
<b class="nc">&nbsp;            LOG.warn(&quot;SQLite JDBC driver not found on classpath, falling back to in-memory.&quot;);</b>
<b class="nc">&nbsp;            driverLoaded = false;</b>
&nbsp;        }
&nbsp;
<b class="pc">&nbsp;        if (driverLoaded) {</b>
<b class="fc">&nbsp;            try (Connection conn = DriverManager.getConnection(AppConfig.DB_URL)) {</b>
<b class="fc">&nbsp;                available = true;</b>
<b class="fc">&nbsp;                conn.setAutoCommit(false);</b>
&nbsp;                try {
<b class="fc">&nbsp;                    ensureSchemaVersion(conn);</b>
<b class="fc">&nbsp;                    createTables(conn);</b>
<b class="fc">&nbsp;                    seedData(conn);</b>
<b class="fc">&nbsp;                    conn.commit();</b>
&nbsp;                } catch (SQLException e) {
<b class="nc">&nbsp;                    conn.rollback();</b>
&nbsp;                    throw e;
&nbsp;                }
&nbsp;            } catch (SQLException e) {
<b class="nc">&nbsp;                available = false;</b>
<b class="nc">&nbsp;                LOG.error(&quot;DB unavailable, falling back to in-memory repositories&quot;, e);</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            available = false;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private Database() {
&nbsp;    }
&nbsp;
&nbsp;    public static boolean isAvailable() {
<b class="fc">&nbsp;        return available;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static Connection getConnection() throws SQLException {
<b class="fc">&nbsp;        return DriverManager.getConnection(AppConfig.DB_URL);</b>
&nbsp;    }
&nbsp;
&nbsp;    private static void ensureSchemaVersion(Connection conn) throws SQLException {
<b class="fc">&nbsp;        try (Statement stmt = conn.createStatement()) {</b>
<b class="fc">&nbsp;            stmt.executeUpdate(&quot;&quot;&quot;</b>
&nbsp;                    CREATE TABLE IF NOT EXISTS schema_version(
&nbsp;                        version INTEGER PRIMARY KEY,
&nbsp;                        applied_at TEXT NOT NULL
&nbsp;                    )
&nbsp;                    &quot;&quot;&quot;);
&nbsp;        }
<b class="fc">&nbsp;        int currentVersion = getSchemaVersion(conn);</b>
<b class="pc">&nbsp;        if (currentVersion &lt; AppConfig.SCHEMA_VERSION) {</b>
<b class="nc">&nbsp;            try (PreparedStatement ps = conn.prepareStatement(</b>
&nbsp;                    &quot;INSERT OR REPLACE INTO schema_version(version, applied_at) VALUES(?, datetime(&#39;now&#39;))&quot;)) {
<b class="nc">&nbsp;                ps.setInt(1, AppConfig.SCHEMA_VERSION);</b>
<b class="nc">&nbsp;                ps.executeUpdate();</b>
&nbsp;            }
<b class="nc">&nbsp;            LOG.info(&quot;Schema version set to {}&quot;, AppConfig.SCHEMA_VERSION);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static void createTables(Connection conn) throws SQLException {
<b class="fc">&nbsp;        try (Statement stmt = conn.createStatement()) {</b>
<b class="fc">&nbsp;            stmt.executeUpdate(&quot;&quot;&quot;</b>
&nbsp;                    CREATE TABLE IF NOT EXISTS employee(
&nbsp;                        id TEXT PRIMARY KEY,
&nbsp;                        username TEXT UNIQUE NOT NULL,
&nbsp;                        password_hash TEXT NOT NULL,
&nbsp;                        role TEXT NOT NULL,
&nbsp;                        base_salary REAL NOT NULL,
&nbsp;                        bonus_rate REAL NOT NULL,
&nbsp;                        upline_id TEXT,
&nbsp;                        status TEXT NOT NULL
&nbsp;                    )
&nbsp;                    &quot;&quot;&quot;);
<b class="fc">&nbsp;            stmt.executeUpdate(&quot;&quot;&quot;</b>
&nbsp;                    CREATE TABLE IF NOT EXISTS member(
&nbsp;                        member_id TEXT PRIMARY KEY,
&nbsp;                        name TEXT NOT NULL,
&nbsp;                        ic_number TEXT UNIQUE NOT NULL,
&nbsp;                        credit_balance REAL NOT NULL,
&nbsp;                        join_date TEXT NOT NULL,
&nbsp;                        status TEXT NOT NULL
&nbsp;                    )
&nbsp;                    &quot;&quot;&quot;);
<b class="fc">&nbsp;            stmt.executeUpdate(&quot;&quot;&quot;</b>
&nbsp;                    CREATE TABLE IF NOT EXISTS customer(
&nbsp;                        customer_id TEXT PRIMARY KEY,
&nbsp;                        name TEXT NOT NULL,
&nbsp;                        registered_date TEXT NOT NULL,
&nbsp;                        last_purchase_date TEXT
&nbsp;                    )
&nbsp;                    &quot;&quot;&quot;);
<b class="fc">&nbsp;            stmt.executeUpdate(&quot;&quot;&quot;</b>
&nbsp;                    CREATE TABLE IF NOT EXISTS product(
&nbsp;                        product_id TEXT PRIMARY KEY,
&nbsp;                        name TEXT NOT NULL,
&nbsp;                        category TEXT NOT NULL,
&nbsp;                        price REAL NOT NULL,
&nbsp;                        status TEXT NOT NULL
&nbsp;                    )
&nbsp;                    &quot;&quot;&quot;);
<b class="fc">&nbsp;            stmt.executeUpdate(&quot;&quot;&quot;</b>
&nbsp;                    CREATE TABLE IF NOT EXISTS stock(
&nbsp;                        product_id TEXT NOT NULL,
&nbsp;                        size TEXT NOT NULL,
&nbsp;                        quantity INTEGER NOT NULL,
&nbsp;                        PRIMARY KEY(product_id, size)
&nbsp;                    )
&nbsp;                    &quot;&quot;&quot;);
<b class="fc">&nbsp;            stmt.executeUpdate(&quot;&quot;&quot;</b>
&nbsp;                    CREATE TABLE IF NOT EXISTS transaction_header(
&nbsp;                        transaction_id TEXT PRIMARY KEY,
&nbsp;                        datetime TEXT NOT NULL,
&nbsp;                        member_id TEXT,
&nbsp;                        customer_id TEXT,
&nbsp;                        total_amount REAL NOT NULL,
&nbsp;                        payment_method TEXT NOT NULL
&nbsp;                    )
&nbsp;                    &quot;&quot;&quot;);
<b class="fc">&nbsp;            stmt.executeUpdate(&quot;&quot;&quot;</b>
&nbsp;                    CREATE TABLE IF NOT EXISTS transaction_item(
&nbsp;                        transaction_id TEXT NOT NULL,
&nbsp;                        line_no INTEGER NOT NULL,
&nbsp;                        product_id TEXT NOT NULL,
&nbsp;                        size TEXT NOT NULL,
&nbsp;                        quantity INTEGER NOT NULL,
&nbsp;                        unit_price REAL NOT NULL,
&nbsp;                        PRIMARY KEY(transaction_id, line_no)
&nbsp;                    )
&nbsp;                    &quot;&quot;&quot;);
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static void seedData(Connection conn) throws SQLException {
<b class="fc">&nbsp;        seedEmployees(conn);</b>
<b class="fc">&nbsp;        seedMembers(conn);</b>
<b class="fc">&nbsp;        seedCustomers(conn);</b>
<b class="fc">&nbsp;        seedProducts(conn);</b>
&nbsp;    }
&nbsp;
&nbsp;    private static void seedEmployees(Connection conn) throws SQLException {
<b class="fc">&nbsp;        int count = getCount(conn, &quot;employee&quot;);</b>
<b class="pc">&nbsp;        if (count &gt; 0) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        try (Statement stmt = conn.createStatement()) {</b>
<b class="nc">&nbsp;            String managerHash = HASHER.hash(&quot;password123&quot;);</b>
<b class="nc">&nbsp;            String staffHash = HASHER.hash(&quot;password123&quot;);</b>
<b class="nc">&nbsp;            stmt.executeUpdate(String.format(&quot;&quot;&quot;</b>
&nbsp;                    INSERT INTO employee(id, username, password_hash, role, base_salary, bonus_rate, status)
&nbsp;                    VALUES (&#39;M001&#39;,&#39;manager&#39;,&#39;%s&#39;,&#39;MANAGER&#39;,5000.0,0.20,&#39;ACTIVE&#39;)
&nbsp;                    &quot;&quot;&quot;, managerHash));
<b class="nc">&nbsp;            stmt.executeUpdate(String.format(&quot;&quot;&quot;</b>
&nbsp;                    INSERT INTO employee(id, username, password_hash, role, base_salary, bonus_rate, upline_id, status)
&nbsp;                    VALUES (&#39;S001&#39;,&#39;staff&#39;,&#39;%s&#39;,&#39;STAFF&#39;,3000.0,0.10,&#39;M001&#39;,&#39;ACTIVE&#39;)
&nbsp;                    &quot;&quot;&quot;, staffHash));
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static void seedMembers(Connection conn) throws SQLException {
<b class="fc">&nbsp;        int count = getCount(conn, &quot;member&quot;);</b>
<b class="pc">&nbsp;        if (count &gt; 0) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        try (Statement stmt = conn.createStatement()) {</b>
<b class="nc">&nbsp;            stmt.executeUpdate(&quot;&quot;&quot;</b>
&nbsp;                    INSERT INTO member(member_id, name, ic_number, credit_balance, join_date, status)
&nbsp;                    VALUES (&#39;MB001&#39;,&#39;Alex Member&#39;,&#39;990101010101&#39;,100.0,date(&#39;now&#39;),&#39;ACTIVE&#39;)
&nbsp;                    &quot;&quot;&quot;);
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static void seedCustomers(Connection conn) throws SQLException {
<b class="fc">&nbsp;        int count = getCount(conn, &quot;customer&quot;);</b>
<b class="pc">&nbsp;        if (count &gt; 0) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        try (Statement stmt = conn.createStatement()) {</b>
<b class="nc">&nbsp;            stmt.executeUpdate(&quot;&quot;&quot;</b>
&nbsp;                    INSERT INTO customer(customer_id, name, registered_date)
&nbsp;                    VALUES (&#39;CU001&#39;,&#39;Walk-in&#39;,date(&#39;now&#39;))
&nbsp;                    &quot;&quot;&quot;);
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static void seedProducts(Connection conn) throws SQLException {
<b class="fc">&nbsp;        int count = getCount(conn, &quot;product&quot;);</b>
<b class="pc">&nbsp;        if (count &gt; 0) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        try (Statement stmt = conn.createStatement()) {</b>
<b class="nc">&nbsp;            stmt.executeUpdate(&quot;&quot;&quot;</b>
&nbsp;                    INSERT INTO product(product_id,name,category,price,status)
&nbsp;                    VALUES (&#39;P001&#39;,&#39;Basic Tee&#39;,&#39;Clothes&#39;,19.90,&#39;ACTIVE&#39;)
&nbsp;                    &quot;&quot;&quot;);
<b class="nc">&nbsp;            stmt.executeUpdate(&quot;&quot;&quot;</b>
&nbsp;                    INSERT INTO product(product_id,name,category,price,status)
&nbsp;                    VALUES (&#39;P002&#39;,&#39;Running Shoe&#39;,&#39;Shoes&#39;,120.00,&#39;ACTIVE&#39;)
&nbsp;                    &quot;&quot;&quot;);
<b class="nc">&nbsp;            stmt.executeUpdate(&quot;&quot;&quot;</b>
&nbsp;                    INSERT OR REPLACE INTO stock(product_id,size,quantity) VALUES (&#39;P001&#39;,&#39;M&#39;,10)
&nbsp;                    &quot;&quot;&quot;);
<b class="nc">&nbsp;            stmt.executeUpdate(&quot;&quot;&quot;</b>
&nbsp;                    INSERT OR REPLACE INTO stock(product_id,size,quantity) VALUES (&#39;P001&#39;,&#39;L&#39;,8)
&nbsp;                    &quot;&quot;&quot;);
<b class="nc">&nbsp;            stmt.executeUpdate(&quot;&quot;&quot;</b>
&nbsp;                    INSERT OR REPLACE INTO stock(product_id,size,quantity) VALUES (&#39;P002&#39;,&#39;42&#39;,5)
&nbsp;                    &quot;&quot;&quot;);
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static int getCount(Connection conn, String table) throws SQLException {
<b class="pc">&nbsp;        try (Statement stmt = conn.createStatement();</b>
<b class="fc">&nbsp;             ResultSet rs = stmt.executeQuery(&quot;SELECT COUNT(*) AS c FROM &quot; + table)) {</b>
<b class="pc">&nbsp;            return rs.next() ? rs.getInt(&quot;c&quot;) : 0;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static int getSchemaVersion(Connection conn) throws SQLException {
<b class="pc">&nbsp;        try (Statement stmt = conn.createStatement();</b>
<b class="fc">&nbsp;             ResultSet rs = stmt.executeQuery(&quot;SELECT COALESCE(MAX(version), 0) AS v FROM schema_version&quot;)) {</b>
<b class="pc">&nbsp;            return rs.next() ? rs.getInt(&quot;v&quot;) : 0;</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-12-12 10:30</div>
</div>
</body>
</html>
